Parameters:
  ClusterName:
    Type: String
    Description: The name of the EKS cluster.

  ExternalID:
    Type: String
    Description: The external ID for assuming the IAM role generated by Vaticy - Do not change!

Resources:
  Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "Vaticy-EKS-Viewer-${ClusterName}-${AWS::Region}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: "arn:aws:iam::767398131998:user/vaticy-cluster-watcher"
            Condition:
              StringEquals:
                sts:ExternalId: !Ref ExternalID
            Action: "sts:AssumeRole"

  RolePolicy:
    Type: AWS::IAM::RolePolicy
    DependsOn: Role
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: "EKSReadAccess"
            Effect: Allow
            Action:
              - "eks:DescribeCluster"
            Resource:
              - !Sub "arn:aws:eks:${AWS::Region}:${AWS::AccountId}:cluster/${ClusterName}"
      RoleName: !Sub "Vaticy-EKS-Viewer-${ClusterName}-${AWS::Region}"
      PolicyName: !Sub "Vaticy-EKS-Read-Access-${ClusterName}-${AWS::Region}"

Outputs:
  RoleArn:
    Description: The ARN of the created IAM Role.
    Value: !GetAtt Role.Arn